cmake_minimum_required(VERSION 3.16)
project(FFExample)
#Setting environment
set(SCRITS_HOME "${CMAKE_SOURCE_DIR}/scripts")
set(DEPS "${CMAKE_SOURCE_DIR}/deps")
set(FFMPEG_HOME "${DEPS}/ffmpeg")
set(X264_HOME "${DEPS}/x264")
set(AVFORMAT "${FFMPEG_HOME}/libavformat/libavformat.a")
set(AVCODEC "${FFMPEG_HOME}/libavcodec/libavcodec.a")
set(AVUTIL "${FFMPEG_HOME}/libavutil/libavutil.a")
set(SWRESAMPLE "${FFMPEG_HOME}/libswresample/libswresample.a")
set(SWSCALE "${FFMPEG_HOME}/libswscale/libswscale.a")
set(X264 "${X264_HOME}/libx264.a")
set(FFMPEG_OPTS --enable-gpl --enable-small --disable-programs --disable-doc --enable-libx264 --arch=x86_64 --cross-prefix=x86_64-unknown-linux-musl- --target-os=linux --extra-cflags='-I../x264' --extra-ldflags='-L../x264' --enable-pic --enable-lto)
set(X264_OPTS --enable-static --enable-lto --enable-pic --enable-strip --cross-prefix=x86_64-unknown-linux-musl-)
file(MAKE_DIRECTORY ${DEPS})
include_directories(${FFMPEG_HOME})
#Setting custom commands for x264
add_custom_command(OUTPUT ${X264_HOME}/config.h COMMAND ./configure ${X264_OPTS} DEPENDS libx264-download WORKING_DIRECTORY ${X264_HOME})
add_custom_command(OUTPUT ${X264_HOME}/libx264.a COMMAND make DEPENDS libx264-config WORKING_DIRECTORY ${X264_HOME})
#Setting custom commands for FFmpeg
add_custom_command(OUTPUT ${FFMPEG_HOME}/config.h COMMAND ./configure ${FFMPEG_OPTS} DEPENDS libav-download libx264 WORKING_DIRECTORY ${FFMPEG_HOME})
add_custom_command(OUTPUT ${FFMPEG_HOME}/libavutil/libavutil.a ${FFMPEG_HOME}/libavformat/libavformat.a ${FFMPEG_HOME}/libavcodec/libavcodec.a ${FFMPEG_HOME}/libswresample/libswresample.a ${FFMPEG_HOME}/libswscale/libswscale.a COMMAND make DEPENDS libav-config WORKING_DIRECTORY ${FFMPEG_HOME})
#Setting custom targets for x264
add_custom_target(libx264-download ALL COMMAND ${SCRIPTS_HOME}/checkExists.sh ${X264_HOME} https://code.videolan.org/videolan/x264.git stable BYPRODUCTS ${X264_HOME} WORKING_DIRECTORY ${DEPS})
add_custom_target(libx264-config DEPENDS ${X264_HOME}/.git/index ${X264_HOME}/config.h)
add_custom_target(libx264 DEPENDS ${X264_HOME}/libx264.a)
#Setting custom targets for FFmpeg
add_custom_target(libav-download ALL COMMAND ${SCRIPTS_HOME}/checkExists.sh ${FFMPEG_HOME} https://git.ffmpeg.org/ffmpeg.git BYPRODUCTS ${FFMPEG_HOME} WORKING_DIRECTORY ${DEPS}) 
add_custom_target(libav-config DEPENDS ${X264_HOME}/.git/index ${FFMPEG_HOME}/config.h)
add_custom_target(libav-libs DEPENDS ${FFMPEG_HOME}/libavutil/libavutil.a ${FFMPEG_HOME}/libavformat/libavformat.a ${FFMPEG_HOME}/libavcodec/libavcodec.a ${FFMPEG_HOME}/libswresample/libswresample.a ${FFMPEG_HOME}/libswscale/libswscale.a)
#Actual project building
add_executable(FFE FFExample.c)
add_dependencies(FFE libav-libs)
target_link_libraries(FFE -static ${SWSCALE} ${AVFORMAT} ${AVCODEC} ${SWRESAMPLE} ${AVUTIL} ${X264})